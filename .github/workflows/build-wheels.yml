name: Build Wheels

on:
  workflow_call:
    inputs:
      is_dev:
        description: 'Whether to build as dev package (nanovdb-editor-dev) with -dev version suffix'
        required: true
        type: boolean
    outputs:
      version_valid:
        description: 'Whether version validation passed'
        value: ${{ jobs.validate_version.outputs.version_valid }}

jobs:
  validate_version:
    name: Validate tag version matches VERSION.txt
    runs-on: ubuntu-latest
    outputs:
      version_valid: ${{ steps.validate.outputs.version-valid || 'true' }}
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Validate version
      id: validate
      if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
      uses: ./.github/actions/validate-version
      with:
        allow-dev-suffix: ${{ inputs.is_dev }}

  build_wheels:
    name: Build (${{ matrix.os }}${{ matrix.arch && format(' {0}', matrix.arch) || '' }})
    runs-on: ${{ matrix.os }}
    needs: [validate_version]
    if: ${{ !failure() && (github.event_name == 'pull_request' || github.event_name == 'workflow_dispatch' || needs.validate_version.outputs.version_valid == 'true') }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            arch: x86_64
            cibw_build: "cp311-manylinux_x86_64"
            cibw_environment: >
              CMAKE_ARGS="-DNANOVDB_EDITOR_PYPI_BUILD=ON -DNANOVDB_EDITOR_BUILD_TESTS=OFF -DNANOVDB_EDITOR_BUILD_SLANG_FROM_SOURCE=ON -DFETCHCONTENT_QUIET=OFF"
              CPM_SOURCE_CACHE=/tmp/cpm-cache
          - os: ubuntu-24.04-arm
            arch: ARM64
            cibw_build: "cp311-manylinux_aarch64"
            cibw_environment: >
              CMAKE_ARGS="-DNANOVDB_EDITOR_PYPI_BUILD=ON -DNANOVDB_EDITOR_BUILD_TESTS=OFF -DFETCHCONTENT_QUIET=OFF"
              CPM_SOURCE_CACHE=/tmp/cpm-cache
          - os: windows-latest
            arch: ""
            cibw_build: "cp311-win_amd64"
            cibw_environment: >
              CMAKE_ARGS="-DNANOVDB_EDITOR_PYPI_BUILD=ON -DNANOVDB_EDITOR_BUILD_TESTS=OFF -DFETCHCONTENT_QUIET=OFF"
              CPM_SOURCE_CACHE=/tmp/cpm-cache
          - os: windows-11-arm
            arch: ARM64
            cibw_build: "cp311-win_arm64"
            cibw_environment: >
              CMAKE_ARGS="-DNANOVDB_EDITOR_PYPI_BUILD=ON -DNANOVDB_EDITOR_BUILD_TESTS=OFF -DFETCHCONTENT_QUIET=OFF"
              CPM_SOURCE_CACHE=/tmp/cpm-cache

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Set up Python (ARM64)
      if: matrix.os == 'windows-11-arm'
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        architecture: arm64

    - name: Set up Python
      if: matrix.os != 'windows-11-arm'
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Rename package for dev release
      if: inputs.is_dev
      shell: bash
      run: |
        sed -i 's/name = "nanovdb-editor"/name = "nanovdb-editor-dev"/' pymodule/pyproject.toml
        cat pymodule/pyproject.toml | grep "name ="

    - name: Install libminiz
      if: runner.os == 'Linux'
      run: sudo apt-get update && sudo apt-get install -y libminiz3

    - name: Build wheels
      uses: pypa/cibuildwheel@v2.21.3
      env:
        CIBW_BUILD: ${{ matrix.cibw_build }}
        CIBW_MANYLINUX_X86_64_IMAGE: quay.io/pypa/manylinux_2_34_x86_64:latest
        CIBW_MANYLINUX_AARCH64_IMAGE: quay.io/pypa/manylinux_2_34_aarch64:latest
        CIBW_BUILD_VERBOSITY: 1
        CIBW_ARCHS: ${{ matrix.os == 'ubuntu-24.04-arm' && 'aarch64' || 'auto' }}
        CIBW_ARCHS_WINDOWS: ${{ matrix.os == 'windows-11-arm' && 'ARM64' || 'auto' }}

        # Linux dependencies
        CIBW_BEFORE_ALL_LINUX: |
          if command -v dnf &> /dev/null; then
            dnf install -y cmake git
            dnf install -y libXrandr-devel libxcb-devel libxkbcommon-x11-devel libXinerama-devel wayland-protocols-devel
          else
            yum install -y cmake git
            yum install -y libXrandr-devel libxcb-devel libxkbcommon-x11-devel libXinerama-devel
          fi
          cmake --version

        # Windows dependencies
        CIBW_BEFORE_ALL_WINDOWS: |
          python -m pip install cmake
          cmake --version

        CIBW_REPAIR_WHEEL_COMMAND_LINUX: |
          set -e
          if [[ "{wheel}" == *"aarch64"* ]]; then
            auditwheel repair -w {dest_dir} {wheel} --lib-sdir .libs --plat manylinux_2_34_aarch64
          else
            auditwheel repair -w {dest_dir} {wheel} --lib-sdir .libs --plat manylinux_2_34_x86_64
          fi

        # Install test dependencies before testing
        CIBW_TEST_REQUIRES: numpy

        # Test the wheels
        CIBW_TEST_COMMAND: python -c "import nanovdb_editor; print('Import successful')"

        # Mark this as a PyPI build, disable gtests for published wheels
        # Add retry and timeout settings for CMake downloads
        CIBW_ENVIRONMENT: ${{ matrix.cibw_environment }}
      with:
        package-dir: pymodule

    - uses: actions/upload-artifact@v4
      with:
        name: wheels-${{ matrix.os }}${{ matrix.arch && format('-{0}', matrix.arch) || '' }}
        path: ./wheelhouse/*.whl

  build_sdist:
    name: Build source distribution
    runs-on: ubuntu-latest
    needs: [validate_version]
    if: ${{ !failure() && (github.event_name == 'pull_request' || github.event_name == 'workflow_dispatch' || needs.validate_version.outputs.version_valid == 'true') }}
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Rename package for dev release
      if: inputs.is_dev
      run: |
        sed -i 's/name = "nanovdb-editor"/name = "nanovdb-editor-dev"/' pymodule/pyproject.toml
        cat pymodule/pyproject.toml | grep "name ="

    - name: Build sdist
      run: pipx run build --sdist
      working-directory: pymodule

    - uses: actions/upload-artifact@v4
      with:
        name: sdist
        path: pymodule/dist/*.tar.gz
