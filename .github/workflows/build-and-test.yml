name: NanoVDB Editor

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
    paths-ignore:
        - 'CODEOWNERS'
        - '**.md'
        - 'dev_utils/**'
  workflow_dispatch:
    inputs:
      branch:
        description: "Branch to build"
        required: true
        default: "main"

# Allow subsequent pushes to the same PR or REF to cancel any previous jobs.
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  deployments: write
  pull-requests: read
  issues: read

jobs:
  nanovdb-editor-build-and-test-linux:
    name: Build and Test (Linux)
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash -el {0}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Vulkan dependencies
        run: |
          set -e
          sudo apt-get update
          sudo apt-get install -y mesa-vulkan-drivers vulkan-tools
          sudo apt-get install -y libxcb1-dev libxcb-keysyms1-dev libxcb-randr0-dev libxcb-xinerama0-dev libx11-xcb-dev libxrandr-dev libwayland-dev wayland-protocols libdirectfb-dev

      - name: Build NanoVDB Editor (GLFW disabled)
        run: |
          set -e
          chmod +x ./build.sh
          ./build.sh -rfv

      - name: Build NanoVDB Editor (GLFW enabled)
        run: |
          set -e
          chmod +x ./build.sh
          ./build.sh -rfv

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: nanovdb-editor-build-linux
          path: |
            build/
          retention-days: 2

      - name: Run GTests
        run: |
          set -e
          export LD_LIBRARY_PATH=$PWD/build/Release/lib:$PWD/build/Release/bin:$LD_LIBRARY_PATH
          ctest --test-dir build/Release/gtests -C Release --output-on-failure --verbose

  nanovdb-editor-build-and-test-windows:
    name: Build and Test (Windows)
    runs-on: windows-latest
    defaults:
      run:
        shell: pwsh
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build NanoVDB Editor (GLFW disabled)
        run: |
          ./build.bat -rfv

      - name: Build NanoVDB Editor (GLFW enabled)
        run: |
          ./build.bat -rv

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: nanovdb-editor-build-windows
          path: |
            build/
          retention-days: 2

      - name: Install Mesa3D lavapipe
        run: |
          # Download Mesa3D with lavapipe for Windows
          Write-Host "Downloading Mesa3D lavapipe..."
          $MesaUrl = "https://github.com/pal1000/mesa-dist-win/releases/download/24.2.7/mesa3d-24.2.7-release-msvc.7z"
          $MesaArchive = "$env:TEMP\mesa3d.7z"
          $MesaDir = "$env:TEMP\mesa3d"

          Invoke-WebRequest -Uri $MesaUrl -OutFile $MesaArchive

          # Extract Mesa3D
          Write-Host "Extracting Mesa3D..."
          7z x $MesaArchive -o"$MesaDir" -y

          # Verify vulkan_lvp.dll exists
          $VulkanLvpDll = Join-Path $MesaDir "x64\vulkan_lvp.dll"
          if (Test-Path $VulkanLvpDll) {
              Write-Host "Found vulkan_lvp.dll at: $VulkanLvpDll"
          } else {
              Write-Host "ERROR: vulkan_lvp.dll not found!"
              Write-Host "Contents of x64 directory:"
              Get-ChildItem (Join-Path $MesaDir "x64") | Format-Table Name
              exit 1
          }

          # Register lavapipe ICD in Windows Registry
          $VulkanICDPath = Join-Path $MesaDir "x64\lvp_icd.x86_64.json"
          $RegistryPath = "HKLM:\SOFTWARE\Khronos\Vulkan\Drivers"

          Write-Host "Registering lavapipe ICD in registry..."
          if (-not (Test-Path $RegistryPath)) {
              New-Item -Path $RegistryPath -Force | Out-Null
          }
          New-ItemProperty -Path $RegistryPath -Name $VulkanICDPath -Value 0 -PropertyType DWord -Force | Out-Null

          Write-Host "Registry entry created: $VulkanICDPath"

          # Add Mesa to PATH
          $MesaBinPath = Join-Path $MesaDir "x64"
          echo "$MesaBinPath" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

          Write-Host "Lavapipe installed successfully"

      - name: Run GTests
        run: |
          cd build/gtests
          ctest -C Release --output-on-failure --verbose

  nanovdb-editor-build-and-test-windows-arm:
    name: Build and Test (Windows ARM64)
    runs-on: windows-11-arm
    defaults:
      run:
        shell: pwsh
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build NanoVDB Editor (GLFW disabled)
        run: |
          ./build.bat -rfv

      - name: Build NanoVDB Editor (GLFW enabled)
        run: |
          ./build.bat -rv

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: nanovdb-editor-build-windows-arm64
          path: |
            build/
          retention-days: 2

      - name: Install Mesa3D lavapipe
        run: |
          # Download Mesa3D with lavapipe for Windows ARM64
          Write-Host "Downloading Mesa3D lavapipe for ARM64..."
          $MesaUrl = "https://github.com/pal1000/mesa-dist-win/releases/download/24.2.7/mesa3d-24.2.7-release-msvc.7z"
          $MesaArchive = "$env:TEMP\mesa3d.7z"
          $MesaDir = "$env:TEMP\mesa3d"

          Invoke-WebRequest -Uri $MesaUrl -OutFile $MesaArchive

          # Extract Mesa3D
          Write-Host "Extracting Mesa3D..."
          7z x $MesaArchive -o"$MesaDir" -y

          # Locate lavapipe DLL (layout can differ between Mesa releases)
          $VulkanLvpDll = Get-ChildItem -Path $MesaDir -Recurse -File -Filter "vulkan_lvp.dll" -ErrorAction SilentlyContinue | Select-Object -First 1
          if (-not $VulkanLvpDll) {
              $VulkanLvpDll = Get-ChildItem -Path $MesaDir -Recurse -File -Filter "vulkan_lvp*.dll" -ErrorAction SilentlyContinue | Select-Object -First 1
          }
          if (-not $VulkanLvpDll) {
              Write-Host "ERROR: vulkan_lvp.dll not found for ARM64!"
              Write-Host "Mesa root contents:"
              Get-ChildItem $MesaDir -ErrorAction SilentlyContinue | Format-Table Name
              Write-Host "Searching for Vulkan-related DLLs (top results):"
              Get-ChildItem -Path $MesaDir -Recurse -File -Filter "vulkan*.dll" -ErrorAction SilentlyContinue |
                Select-Object -First 50 FullName | Format-Table -AutoSize
              exit 1
          }
          Write-Host "Found lavapipe DLL at: $($VulkanLvpDll.FullName)"

          # Register lavapipe ICD in Windows Registry
          $VulkanICDJson = Get-ChildItem -Path $MesaDir -Recurse -File -Filter "lvp_icd*.json" -ErrorAction SilentlyContinue |
            Where-Object { $_.Name -match "(aarch64|arm64)" } |
            Select-Object -First 1
          if (-not $VulkanICDJson) {
              $VulkanICDJson = Get-ChildItem -Path $MesaDir -Recurse -File -Filter "lvp_icd*.json" -ErrorAction SilentlyContinue | Select-Object -First 1
          }
          if (-not $VulkanICDJson) {
              Write-Host "ERROR: lvp_icd*.json not found under Mesa directory!"
              Write-Host "Searching for ICD JSON files (top results):"
              Get-ChildItem -Path $MesaDir -Recurse -File -Filter "*.json" -ErrorAction SilentlyContinue |
                Where-Object { $_.Name -match "icd" } |
                Select-Object -First 50 FullName | Format-Table -AutoSize
              exit 1
          }

          $VulkanICDPath = $VulkanICDJson.FullName
          $RegistryPath = "HKLM:\SOFTWARE\Khronos\Vulkan\Drivers"

          Write-Host "Registering lavapipe ICD in registry..."
          if (-not (Test-Path $RegistryPath)) {
              New-Item -Path $RegistryPath -Force | Out-Null
          }
          New-ItemProperty -Path $RegistryPath -Name $VulkanICDPath -Value 0 -PropertyType DWord -Force | Out-Null

          Write-Host "Registry entry created: $VulkanICDPath"

          # Also set VK_ICD_FILENAMES for this job (works even when registry is locked down)
          "VK_ICD_FILENAMES=$VulkanICDPath" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

          # Add Mesa to PATH
          $MesaBinPath = Split-Path -Parent $VulkanLvpDll.FullName
          echo "$MesaBinPath" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

          Write-Host "Lavapipe installed successfully for ARM64"

      - name: Run GTests
        run: |
          cd build/gtests
          ctest -C Release --output-on-failure --verbose

  nanovdb-editor-build-and-test-linux-arm:
    name: Build and Test (Linux ARM64)
    runs-on: ubuntu-24.04-arm
    defaults:
      run:
        shell: bash -el {0}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Vulkan dependencies
        run: |
          set -e
          sudo apt-get update
          sudo apt-get install -y mesa-vulkan-drivers vulkan-tools
          sudo apt-get install -y libxcb1-dev libxcb-keysyms1-dev libxcb-randr0-dev libxcb-xinerama0-dev libx11-xcb-dev libxrandr-dev libwayland-dev wayland-protocols libdirectfb-dev
          # Ensure lavapipe is available
          export VK_DRIVER_FILES=/usr/share/vulkan/icd.d/lvp_icd.aarch64.json
          vulkaninfo --summary || true

      - name: Build NanoVDB Editor (GLFW disabled)
        run: |
          set -e
          chmod +x ./build.sh
          ./build.sh -rfv

      - name: Build NanoVDB Editor (GLFW enabled)
        run: |
          set -e
          chmod +x ./build.sh
          ./build.sh -rfv

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: nanovdb-editor-build-linux-arm64
          path: |
            build/
          retention-days: 2

      - name: Run GTests
        run: |
          set -e

          # Configure lavapipe for software rendering
          export VK_ICD_FILENAMES=/usr/share/vulkan/icd.d/lvp_icd.aarch64.json
          export VK_DRIVER_FILES=/usr/share/vulkan/icd.d/lvp_icd.aarch64.json

          # Additional lavapipe configuration
          export LP_NUM_THREADS=1
          export LIBGL_ALWAYS_SOFTWARE=1
          export GALLIUM_DRIVER=llvmpipe

          # Verify ICD file exists
          if [ -f "$VK_ICD_FILENAMES" ]; then
              echo "ICD file found: $VK_ICD_FILENAMES"
          else
              echo "ERROR: ICD file not found: $VK_ICD_FILENAMES"
              ls -la /usr/share/vulkan/icd.d/ || true
              exit 1
          fi

          echo "Using Vulkan driver: $VK_DRIVER_FILES"
          echo "LP_NUM_THREADS: $LP_NUM_THREADS"

          export LD_LIBRARY_PATH=$PWD/build/Release/lib:$PWD/build/Release/bin:$LD_LIBRARY_PATH
          ctest --test-dir build/Release/gtests -C Release --output-on-failure --verbose
