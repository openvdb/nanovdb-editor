name: PR Workflow Commands

on:
  issue_comment:
    types: [created]

jobs:
  rerun-failed-workflows:
    name: Rerun Failed Workflows
    if: >
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '/rerun-all') &&
      (
        github.event.comment.author_association == 'OWNER' ||
        github.event.comment.author_association == 'MEMBER' ||
        github.event.comment.author_association == 'COLLABORATOR'
      )
    runs-on: ubuntu-latest
    permissions:
      actions: write
      pull-requests: write
      checks: write
    steps:
      - name: Add reaction to comment
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'rocket'
            });

      - uses: estroz/rerun-actions@v0.3.0
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          comment_id: ${{ github.event.comment.id }}

  run-all-workflows:
    name: Run All Workflows
    if: >
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '/run-all') &&
      (
        github.event.comment.author_association == 'OWNER' ||
        github.event.comment.author_association == 'MEMBER' ||
        github.event.comment.author_association == 'COLLABORATOR'
      )
    runs-on: ubuntu-latest
    permissions:
      actions: write
      pull-requests: write
    steps:
      - name: Add reaction to comment
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'rocket'
            });

      - name: Get PR info
        id: pr-info
        uses: actions/github-script@v7
        with:
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            core.setOutput('ref', pr.data.head.ref);
            console.log(`PR branch: ${pr.data.head.ref}`);

      - name: Trigger all workflows
        uses: actions/github-script@v7
        with:
          script: |
            const ref = '${{ steps.pr-info.outputs.ref }}';
            const workflows = [
              'build-and-test.yml',
              'build-and-test-python.yml',
              'codestyle.yml'
            ];

            // Helper to find the triggered run with retries
            async function findWorkflowRun(workflowId, beforeTime) {
              const maxRetries = 5;
              const delayMs = 3000;

              for (let attempt = 1; attempt <= maxRetries; attempt++) {
                await new Promise(resolve => setTimeout(resolve, delayMs));
                console.log(`Looking for ${workflowId} run (attempt ${attempt}/${maxRetries})...`);

                const runs = await github.rest.actions.listWorkflowRuns({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  workflow_id: workflowId,
                  branch: ref,
                  per_page: 10,
                  event: 'workflow_dispatch'
                });

                // Find a run created after we triggered it
                const run = runs.data.workflow_runs.find(r =>
                  new Date(r.created_at) >= beforeTime
                );

                if (run) {
                  console.log(`Found run: ${run.html_url}`);
                  return run;
                }
              }
              return null;
            }

            const results = [];
            for (const workflow of workflows) {
              const beforeTime = new Date();
              try {
                console.log(`Triggering ${workflow} on ref ${ref}`);
                await github.rest.actions.createWorkflowDispatch({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  workflow_id: workflow,
                  ref: ref
                });
                console.log(`Successfully triggered ${workflow}`);

                // Try to find the run and get its URL
                const run = await findWorkflowRun(workflow, beforeTime);
                if (run) {
                  results.push(`‚úÖ [\`${workflow}\`](${run.html_url})`);
                } else {
                  results.push(`‚úÖ \`${workflow}\` (run pending)`);
                }
              } catch (error) {
                console.log(`Failed to trigger ${workflow}: ${error.message}`);
                results.push(`‚ùå \`${workflow}\`: ${error.message}`);
              }
            }

            // Post summary comment
            const body = `### üöÄ Triggered workflows on branch \`${ref}\`\n\n${results.join('\n')}`;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });

  run-single-workflow:
    name: Run Single Workflow
    if: >
      github.event.issue.pull_request &&
      (
        contains(github.event.comment.body, '/run-build') ||
        contains(github.event.comment.body, '/run-python') ||
        contains(github.event.comment.body, '/run-codestyle')
      ) &&
      (
        github.event.comment.author_association == 'OWNER' ||
        github.event.comment.author_association == 'MEMBER' ||
        github.event.comment.author_association == 'COLLABORATOR'
      )
    runs-on: ubuntu-latest
    permissions:
      actions: write
      pull-requests: write
    steps:
      - name: Add reaction to comment
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'rocket'
            });

      - name: Get PR info
        id: pr-info
        uses: actions/github-script@v7
        with:
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            core.setOutput('ref', pr.data.head.ref);
            console.log(`PR branch: ${pr.data.head.ref}`);

      - name: Trigger requested workflow
        uses: actions/github-script@v7
        with:
          script: |
            const ref = '${{ steps.pr-info.outputs.ref }}';
            const comment = context.payload.comment.body;

            const workflowMap = {
              '/run-build': 'build-and-test.yml',
              '/run-python': 'build-and-test-python.yml',
              '/run-codestyle': 'codestyle.yml'
            };

            // Helper to find the triggered run with retries
            async function findWorkflowRun(workflowId, beforeTime) {
              const maxRetries = 5;
              const delayMs = 3000;

              for (let attempt = 1; attempt <= maxRetries; attempt++) {
                await new Promise(resolve => setTimeout(resolve, delayMs));
                console.log(`Looking for ${workflowId} run (attempt ${attempt}/${maxRetries})...`);

                const runs = await github.rest.actions.listWorkflowRuns({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  workflow_id: workflowId,
                  branch: ref,
                  per_page: 10,
                  event: 'workflow_dispatch'
                });

                const run = runs.data.workflow_runs.find(r =>
                  new Date(r.created_at) >= beforeTime
                );

                if (run) {
                  console.log(`Found run: ${run.html_url}`);
                  return run;
                }
              }
              return null;
            }

            for (const [command, workflow] of Object.entries(workflowMap)) {
              if (comment.includes(command)) {
                const beforeTime = new Date();
                try {
                  console.log(`Triggering ${workflow} on ref ${ref}`);
                  await github.rest.actions.createWorkflowDispatch({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    workflow_id: workflow,
                    ref: ref
                  });

                  const run = await findWorkflowRun(workflow, beforeTime);
                  const link = run ? `[\`${workflow}\`](${run.html_url})` : `\`${workflow}\``;

                  await github.rest.issues.createComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: context.issue.number,
                    body: `‚úÖ Triggered ${link} on branch \`${ref}\``
                  });
                } catch (error) {
                  await github.rest.issues.createComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: context.issue.number,
                    body: `‚ùå Failed to trigger \`${workflow}\`: ${error.message}`
                  });
                }
              }
            }
