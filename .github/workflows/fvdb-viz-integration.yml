name: fVDB Viewer Integration

on:
  workflow_dispatch:
    inputs:
      package:
        description: "Package stream to validate"
        required: true
        type: choice
        default: release
        options:
          - release
          - dev
  workflow_call:
    inputs:
      package:
        description: "Package stream to validate (release/dev)"
        required: false
        type: string
        default: release
      release_wheel_artifact:
        description: "Artifact name for locally built release wheel"
        required: false
        type: string
        default: ""

env:
  FVDB_VIZ_TORCH_VERSION: "2.8.0"
  FVDB_VIZ_TORCH_INDEX_URL: "https://download.pytorch.org/whl/cu128"
  FVDB_VIZ_CORE_VERSION: "0.3.0+pt28.cu128"
  FVDB_VIZ_CORE_INDEX_URL: "https://d36m13axqqhiit.cloudfront.net/simple"
  FVDB_VIZ_SCRIPT_TIMEOUT: "480"

jobs:
  fvdb-viz-integration:
    runs-on: ubuntu-latest
    steps:
      - name: Resolve package selection
        id: config
        run: |
          set -euo pipefail
          stream="${{ inputs.package }}"
          stream="${stream,,}"
          if [[ -z "$stream" ]]; then
            stream="release"
          fi
          if [[ "$stream" != "release" && "$stream" != "dev" ]]; then
            echo "Unsupported package stream: $stream" >&2
            exit 1
          fi
          use_local="false"
          artifact=""
          if [[ "$stream" == "release" && "${{ inputs.release_wheel_artifact }}" != "" ]]; then
            use_local="true"
            artifact="${{ inputs.release_wheel_artifact }}"
          fi
          {
            echo "package_stream=$stream"
            echo "use_local=$use_local"
            echo "artifact=$artifact"
          } >> "$GITHUB_OUTPUT"

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Prepare wheel directory
        run: |
          rm -rf pymodule/dist
          mkdir -p pymodule/dist

      - name: Download release wheel artifact
        if: ${{ steps.config.outputs.use_local == 'true' }}
        uses: actions/download-artifact@v4
        with:
          name: ${{ steps.config.outputs.artifact }}
          path: pymodule/dist

      - name: Locate local wheel artifact
        if: ${{ steps.config.outputs.use_local == 'true' }}
        id: local_wheel
        run: |
          set -euo pipefail
          wheel_path=$(python -c "import pathlib, sys; dist = pathlib.Path('pymodule') / 'dist'; matches = sorted(dist.glob('nanovdb_editor*.whl')); sys.stdout.write(str(matches[0]) if matches else ''); sys.exit(0 if matches else 1)")
          if [[ -z "$wheel_path" ]]; then
            echo 'No nanovdb_editor*.whl found in pymodule/dist' >&2
            exit 1
          fi
          echo "host_path=${wheel_path}" >> "$GITHUB_OUTPUT"
          echo "container_path=/workspace/${wheel_path}" >> "$GITHUB_OUTPUT"

      - name: Build headless test image
        run: |
          set -euo pipefail
          if [[ "${{ steps.config.outputs.package_stream }}" == "dev" ]]; then
            PACKAGE_NAME="nanovdb-editor-dev"
          else
            PACKAGE_NAME="nanovdb-editor"
          fi
          docker build \
            --progress=plain \
            --network=host \
            --build-arg PYPI_PACKAGE="${PACKAGE_NAME}" \
            --build-arg USE_LOCAL_WHEEL="${{ steps.config.outputs.use_local }}" \
            --build-arg INSTALL_GRAPHICS_LIBS=false \
            -t "fvdb-viz-${{ steps.config.outputs.package_stream }}" \
            .

      - name: Run fvdb.viz notebook workflow
        run: |
          if [[ "${{ steps.config.outputs.use_local }}" == "true" ]]; then
            PYTEST_EXPR="test_fvdb_viz_with_local_package"
          elif [[ "${{ steps.config.outputs.package_stream }}" == "dev" ]]; then
            PYTEST_EXPR="test_fvdb_viz_with_dev_package"
          else
            PYTEST_EXPR="test_fvdb_viz_with_release_package"
          fi

          LOCAL_DIST_ENV=""
          if [[ "${{ steps.config.outputs.use_local }}" == "true" ]]; then
            LOCAL_DIST_ENV="-e FVDB_VIZ_LOCAL_DIST=${{ steps.local_wheel.outputs.container_path }}"
          fi

          docker run --rm \
            -e FVDB_VIZ_TESTS=1 \
            -e FVDB_VIZ_TORCH_VERSION="${FVDB_VIZ_TORCH_VERSION}" \
            -e FVDB_VIZ_TORCH_INDEX_URL="${FVDB_VIZ_TORCH_INDEX_URL}" \
            -e FVDB_VIZ_CORE_VERSION="${FVDB_VIZ_CORE_VERSION}" \
            -e FVDB_VIZ_CORE_INDEX_URL="${FVDB_VIZ_CORE_INDEX_URL}" \
            -e FVDB_VIZ_SCRIPT_TIMEOUT="${FVDB_VIZ_SCRIPT_TIMEOUT}" \
            -e VK_ICD_FILENAMES=/usr/share/vulkan/icd.d/lvp_icd.x86_64.json \
            -e VK_DRIVER_FILES=/usr/share/vulkan/icd.d/lvp_icd.x86_64.json \
            -e LP_NUM_THREADS=1 \
            -e LIBGL_ALWAYS_SOFTWARE=1 \
            -e GALLIUM_DRIVER=llvmpipe \
            ${LOCAL_DIST_ENV} \
            -v "${GITHUB_WORKSPACE}":/workspace \
            -w /workspace \
            "fvdb-viz-${{ steps.config.outputs.package_stream }}" \
            sh -c 'python3 -m pip install --break-system-packages pytest >/tmp/pip.log 2>&1; python3 -c "import importlib; mod = importlib.import_module(\"nanovdb_editor\"); version = getattr(mod, \"__version__\", \"unknown\"); print(f\"nanovdb_editor version: {version}\")"; pytest pytests/test_fvdb_viz_integration.py -k "'"${PYTEST_EXPR}"'" -vv; PYTEST_EXIT=$?; echo "Pytest exit code: $PYTEST_EXIT"; exit $PYTEST_EXIT'
          DOCKER_EXIT_CODE=$?
          echo "Docker exit code: ${DOCKER_EXIT_CODE}"
          if [[ ${DOCKER_EXIT_CODE} -ne 0 ]]; then
            echo "::error::fvdb.viz pytest failed with exit code ${DOCKER_EXIT_CODE}"
            exit ${DOCKER_EXIT_CODE}
          fi

