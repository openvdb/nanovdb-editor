name: Build fvdb.viz Test Image

on:
  workflow_call:
    inputs:
      image_name:
        required: false
        type: string
        default: fvdb-test-image
      torch_version:
        required: false
        type: string
        default: "2.8.0"
      torch_index_url:
        required: false
        type: string
        default: "https://download.pytorch.org/whl/cu128"
      fvdb_core_version:
        required: true
        type: string
      fvdb_core_index_url:
        required: false
        type: string
        default: "https://d36m13axqqhiit.cloudfront.net/simple"
    outputs:
      image_ref:
        description: "Fully qualified image reference pushed to registry"
        value: ${{ jobs.build-and-push-image.outputs.image_ref }}

jobs:
  build-and-push-image:
    name: Build and Push Test Image
    runs-on: ubuntu-latest
    outputs:
      image_ref: ${{ steps.compute_ref.outputs.image_ref }}
    env:
      IMAGE_NAME: ${{ inputs.image_name }}
      TORCH_VERSION: ${{ inputs.torch_version }}
      TORCH_INDEX_URL: ${{ inputs.torch_index_url }}
      FVDB_CORE_VERSION: ${{ inputs.fvdb_core_version }}
      FVDB_CORE_INDEX_URL: ${{ inputs.fvdb_core_index_url }}
    steps:
      - name: Compute image reference
        id: compute_ref
        run: |
          set -euo pipefail
          core_tag="${FVDB_CORE_VERSION//[^0-9a-zA-Z.-]/-}"
          image_ref="ghcr.io/${{ github.repository_owner }}/${IMAGE_NAME}:${core_tag}"
          echo "image_ref=${image_ref}" >> "$GITHUB_OUTPUT"
          echo "Will build and push: ${image_ref}"

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ secrets.GHCR_PUSH_USERNAME }}
          password: ${{ secrets.GHCR_PUSH_TOKEN }}

      - name: Free disk space
        run: |
          set -euo pipefail
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/lib/jvm
          sudo rm -rf "${AGENT_TOOLSDIRECTORY:-/opt/hostedtoolcache}"
          sudo apt-get clean
          sudo docker system prune --all --force --volumes || true

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and Push
        timeout-minutes: 30
        id: build_push
        run: |
          set -euo pipefail
          IMAGE_REF="${{ steps.compute_ref.outputs.image_ref }}"
          docker buildx build \
            -f docker/Dockerfile.fvdb_viz_test \
            --build-arg TORCH_VERSION="${TORCH_VERSION}" \
            --build-arg TORCH_INDEX_URL="${TORCH_INDEX_URL}" \
            --build-arg FVDB_CORE_VERSION="${FVDB_CORE_VERSION}" \
            --build-arg FVDB_CORE_INDEX_URL="${FVDB_CORE_INDEX_URL}" \
            -t "${IMAGE_REF}" \
            --push \
            --progress=plain \
            "${{ github.workspace }}"
