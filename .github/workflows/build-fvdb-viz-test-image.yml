name: Build fvdb.viz Test Image

on:
  workflow_dispatch:
    inputs:
      image_name:
        description: "Docker image tag (without registry/user)"
        default: fvdb-viz-test
        required: false
        type: string
      torch_version:
        description: "Torch version"
        default: "2.8.0"
        required: false
        type: string
      torch_index_url:
        description: "Torch index URL"
        default: "https://download.pytorch.org/whl/cu128"
        required: false
        type: string
      fvdb_core_version:
        description: "fvdb-core version"
        required: true
        type: string
      fvdb_core_index_url:
        description: "fvdb-core index URL"
        default: "https://d36m13axqqhiit.cloudfront.net/simple"
        required: false
        type: string
  workflow_call:
    inputs:
      image_name:
        required: false
        type: string
        default: fvdb-viz-test
      torch_version:
        required: false
        type: string
        default: "2.8.0"
      torch_index_url:
        required: false
        type: string
        default: "https://download.pytorch.org/whl/cu128"
      fvdb_core_version:
        required: true
        type: string
      fvdb_core_index_url:
        required: false
        type: string
        default: "https://d36m13axqqhiit.cloudfront.net/simple"
    outputs:
      image_ref:
        description: "Fully qualified image reference pushed to registry"
        value: ${{ jobs.build-and-push.outputs.image_ref }}

jobs:
  build-and-push-image:
    name: Build and Push Test Image
    runs-on: ubuntu-latest
    outputs:
      image_ref: ${{ steps.build_push.outputs.image_ref }}
    env:
      IMAGE_NAME: ${{ inputs.image_name }}
      TORCH_VERSION: ${{ inputs.torch_version }}
      TORCH_INDEX_URL: ${{ inputs.torch_index_url }}
      FVDB_CORE_VERSION: ${{ inputs.fvdb_core_version }}
      FVDB_CORE_INDEX_URL: ${{ inputs.fvdb_core_index_url }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and Push
        timeout-minutes: 30
        id: build_push
        run: |
          set -euo pipefail
          IMAGE_REF="ghcr.io/${{ github.repository_owner }}/${IMAGE_NAME}:${FVDB_CORE_VERSION//[^0-9a-zA-Z.-]/-}"
          docker buildx build \
            -f docker/Dockerfile.fvdb_viz_test \
            --build-arg TORCH_VERSION="${TORCH_VERSION}" \
            --build-arg TORCH_INDEX_URL="${TORCH_INDEX_URL}" \
            --build-arg FVDB_CORE_VERSION="${FVDB_CORE_VERSION}" \
            --build-arg FVDB_CORE_INDEX_URL="${FVDB_CORE_INDEX_URL}" \
            -t "${IMAGE_REF}" \
            --push \
            --progress=plain \
            "${{ github.workspace }}"
          echo "image_ref=${IMAGE_REF}" >> "$GITHUB_OUTPUT"

