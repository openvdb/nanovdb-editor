name: Build fvdb.viz Test Image

on:
  workflow_dispatch:
    inputs:
      image_name:
        description: "Docker image tag to produce"
        default: fvdb-viz-test
        required: false
        type: string
      image_artifact_name:
        description: "Artifact name to upload"
        default: fvdb-viz-test-image
        required: false
        type: string
      torch_version:
        description: "Torch version"
        default: "2.8.0"
        required: false
        type: string
      torch_index_url:
        description: "Torch index URL"
        default: "https://download.pytorch.org/whl/cu128"
        required: false
        type: string
      fvdb_core_version:
        description: "fvdb-core version"
        required: true
        type: string
      fvdb_core_index_url:
        description: "fvdb-core index URL"
        default: "https://d36m13axqqhiit.cloudfront.net/simple"
        required: false
        type: string
  workflow_call:
    inputs:
      image_name:
        required: false
        type: string
        default: fvdb-viz-test
      image_artifact_name:
        required: false
        type: string
        default: fvdb-viz-test-image
      torch_version:
        required: false
        type: string
        default: "2.8.0"
      torch_index_url:
        required: false
        type: string
        default: "https://download.pytorch.org/whl/cu128"
      fvdb_core_version:
        required: true
        type: string
      fvdb_core_index_url:
        required: false
        type: string
        default: "https://d36m13axqqhiit.cloudfront.net/simple"
    outputs:
      image_artifact:
        description: "Name of the uploaded Docker image artifact"
        value: ${{ jobs.build-and-upload.outputs.image_artifact }}

jobs:
  build-and-upload:
    runs-on: ubuntu-latest
    outputs:
      image_artifact: ${{ steps.artifact_metadata.outputs.artifact_name }}
    env:
      IMAGE_NAME: ${{ inputs.image_name }}
      IMAGE_ARTIFACT_NAME: ${{ inputs.image_artifact_name }}
      TORCH_VERSION: ${{ inputs.torch_version }}
      TORCH_INDEX_URL: ${{ inputs.torch_index_url }}
      FVDB_CORE_VERSION: ${{ inputs.fvdb_core_version }}
      FVDB_CORE_INDEX_URL: ${{ inputs.fvdb_core_index_url }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build fvdb.viz test base image
        env:
          FVDB_VIZ_TEST_IMAGE: ${{ env.IMAGE_NAME }}
          FVDB_VIZ_TORCH_VERSION: ${{ env.TORCH_VERSION }}
          FVDB_VIZ_TORCH_INDEX_URL: ${{ env.TORCH_INDEX_URL }}
          FVDB_VIZ_CORE_VERSION: ${{ env.FVDB_CORE_VERSION }}
          FVDB_VIZ_CORE_INDEX_URL: ${{ env.FVDB_CORE_INDEX_URL }}
        run: |
          ./scripts/build_fvdb_viz_test_image.sh

      - name: Prepare artifact metadata
        id: artifact_metadata
        run: |
          TAR_PATH=".cache/${IMAGE_NAME}.tar"
          if [[ ! -f "$TAR_PATH" ]]; then
            echo "Expected image tarball $TAR_PATH not found" >&2
            exit 1
          fi
          echo "artifact_name=${IMAGE_ARTIFACT_NAME}" >> "$GITHUB_OUTPUT"

      - name: Upload Docker image artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.IMAGE_ARTIFACT_NAME }}
          path: .cache/${{ env.IMAGE_NAME }}.tar
          if-no-files-found: error

