FROM ubuntu:24.04

ENV DEBIAN_FRONTEND=noninteractive \
    PIP_DISABLE_PIP_VERSION_CHECK=1 \
    PYTHONUNBUFFERED=1

RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        python3 \
        python3-pip \
        python3-venv \
        mesa-vulkan-drivers \
        libxext6 \
        libegl1 \
        libgl1 && \
    rm -rf /var/lib/apt/lists/*

RUN python3 -m pip install \
        --break-system-packages \
        --ignore-installed \
        --no-cache-dir \
        "pip>=25,<26"

WORKDIR /workspace

ARG TORCH_VERSION=2.8.0
ARG TORCH_INDEX_URL=https://download.pytorch.org/whl/cu128
ARG FVDB_CORE_VERSION=0.3.0
ARG FVDB_CORE_INDEX_URL=https://d36m13axqqhiit.cloudfront.net/simple

RUN if [ -n "$TORCH_INDEX_URL" ]; then \
        python3 -m pip install "torch==${TORCH_VERSION}" --index-url "${TORCH_INDEX_URL}" --break-system-packages; \
    else \
        python3 -m pip install "torch==${TORCH_VERSION}" --break-system-packages; \
    fi

RUN python3 -m pip install \
        "fvdb-core==${FVDB_CORE_VERSION}" \
        --extra-index-url "${FVDB_CORE_INDEX_URL}" \
        --break-system-packages && \
    python3 -m pip install numpy pytest --break-system-packages

